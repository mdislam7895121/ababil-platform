STEP 18 (Native Apps Publish Readiness) — IMPLEMENTATION PROMPT

GOAL
Make the Expo mobile app publish-ready for iOS and Android:
- secure auth token storage
- deep links (preview links, invite links)
- push notifications wiring (Expo)
- environment config for prod/staging/dev
- EAS build readiness checklist
Must be additive and must not break existing web/backend flows.

NON-NEGOTIABLE RULES
1) Additive only. No refactors that risk breaking existing app routes.
2) Use Expo-compatible, version-locked dependencies.
3) No secrets in client. Only public keys/config allowed.
4) Proof-first: raw logs and build config files required.
5) Do NOT start any new steps after STEP 18 proof is delivered.

WHAT TO BUILD

A) Environment Config (Mobile)
1) Add a single config source for API base URL:
- apps/mobile/src/config.ts (or equivalent)
- supports:
  - development (localhost)
  - staging
  - production
2) Use Expo extra / app.config for build-time variables:
- EXPO_PUBLIC_API_URL
- EXPO_PUBLIC_WEB_URL (for deep links)
3) Ensure the app uses this base URL everywhere for API calls.

B) Secure Token Storage
1) Replace any AsyncStorage token storage with:
- expo-secure-store
2) Store:
- access token
- refresh token (if exists)
3) Provide logout that clears secure store.

C) Deep Linking
1) Configure app scheme and linking in app.json/app.config:
- scheme: platformfactory (or project name)
2) Implement routes that open:
- /preview/<token> in-app
- /login redirect handling
3) Add a “Open Preview Link” handler:
- If user is logged in, open preview screen
- If not logged in, store pending deep link and complete after login

D) Push Notifications (Expo)
1) Add:
- expo-notifications
- permissions prompt flow
2) Register device token and send to backend:
- POST /api/push/register (create if missing)
Payload: { expoPushToken, deviceInfo }
3) Add backend connector config if needed:
- Store push tokens per user/tenant
- Add endpoint:
  - POST /api/push/test (admin only) -> sends test notification
4) In mobile UI:
- Settings tab: “Enable notifications” + show token status
- Admin-only (optional): “Send test notification”

E) EAS Build Readiness
1) Add eas.json with profiles:
- development
- preview
- production
2) Add scripts in apps/mobile/package.json:
- build:android
- build:ios
- build:preview
3) Add a checklist page in docs:
- apps/mobile/README.md or root DEPLOY.md section:
  - bundle identifiers
  - app icons/splash
  - permissions
  - Apple/Google store requirements

F) Minimal UI Wiring
In mobile tabs:
- Add a “Preview” screen to open preview tokens
- Add Settings toggles for notifications and environment display

PROOF REQUIRED (MANDATORY)
1) Dependency proof:
- package.json diff showing expo-secure-store + expo-notifications
2) Token storage proof:
- Log snippet showing token stored/retrieved from SecureStore (no token printed in full)
3) Deep link proof:
- Example URL: platformfactory://preview/<token>
- Console/log showing navigation to preview screen
4) Push proof:
- Register token -> raw API response
- Trigger test push -> raw API response
- Mobile receives notification (screenshot or log)
5) EAS config proof:
- eas.json content
- commands used (no need to actually build if credentials missing, but config must be correct)
6) Regression:
- ./scripts/smoke.sh PASS (API/Web unaffected)
7) Artifacts:
- reports/step18-proof.md
- list changed files + git status

STOP CONDITION
Stop after STEP 18 proof delivered.
Do NOT start any further steps.