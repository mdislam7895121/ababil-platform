STEP 17 (Support System + Helpdesk) — IMPLEMENTATION PROMPT

GOAL
Add an in-app support system so customers never get stuck after go-live.
Support must be secure, tenant-scoped, auditable, and integrated with monitoring
(STEP 13) and deploy flows (STEP 16).

NON-NEGOTIABLE RULES
1) Additive only. No refactors to existing routes or UI.
2) Strict RBAC:
   - Customer/Staff can create tickets for their tenant
   - Admin/Owner can respond, resolve, and link incidents
3) No secrets leakage. Attachments/log snippets must be redacted.
4) Proof-first: raw outputs required.
5) Preserve Golden Flows F1–F4.

WHAT TO BUILD

A) Prisma Models (Additive)
1) SupportTicket
- id
- tenantId
- createdByUserId
- subject
- category (deploy | billing | preview | bug | question)
- priority (low | medium | high | critical)
- status (open | in_progress | waiting | solved | closed)
- linkedIncidentId (nullable)
- createdAt, updatedAt, solvedAt

2) SupportMessage
- id
- ticketId
- authorRole (customer | staff | admin)
- message (text)
- attachments (json, optional, redacted metadata only)
- createdAt

B) APIs
Customer/Staff:
- POST /api/support/tickets
- GET /api/support/tickets (own tenant)
- GET /api/support/tickets/:id
- POST /api/support/tickets/:id/messages

Admin/Owner:
- POST /api/support/tickets/:id/status
- POST /api/support/tickets/:id/priority
- POST /api/support/tickets/:id/link-incident
- GET /api/support/admin/tickets (all tenants, filters)

C) “Fix My Deploy” Guided Helper (Rules-based)
- Endpoint: POST /api/support/fix-my-deploy
Body: { tenantId }
Behavior:
- Reads latest preflight + verification results
- Returns ordered checklist with:
  - detected issue
  - why it blocks
  - exact fix steps
- No AI required; deterministic rules only.

D) UI Pages
1) /dashboard/support
- Ticket list (filters: status, priority)
- “Create Ticket” button

2) /dashboard/support/:id
- Thread view (messages)
- Status + priority badges
- Admin actions (status/priority/link incident)

3) Admin view:
- /dashboard/support/admin
- Shows tickets across tenants + SLA timers

E) Monitoring Integration
- Allow linking STEP 13 Incident → SupportTicket
- Show incident badge inside ticket

F) Audit Logs
- SUPPORT_TICKET_CREATED
- SUPPORT_MESSAGE_ADDED
- SUPPORT_STATUS_CHANGED
- SUPPORT_PRIORITY_CHANGED
- SUPPORT_INCIDENT_LINKED

G) Safety
- Redact secrets from messages/logs automatically
- Limit attachment metadata size
- Rate limit ticket creation (e.g., 10/day/tenant)

PROOF REQUIRED (MANDATORY)
1) Create ticket (customer) → raw API output
2) Add message (customer + admin) → raw outputs
3) Change status + priority (admin) → raw outputs
4) Link incident to ticket → raw output
5) “Fix my deploy” returns deterministic checklist
6) RBAC:
   - Staff cannot access admin endpoints (403)
7) UI proof:
   - Ticket list page
   - Ticket thread page
8) Regression:
   - ./scripts/smoke.sh PASS
   - ./scripts/verify.sh PASS (warnings ok if pre-existing)
9) Artifacts:
   - reports/step17-proof.md
   - List changed files + git status

STOP CONDITION
Stop after STEP 17 proof delivered.
Do NOT start STEP 18.