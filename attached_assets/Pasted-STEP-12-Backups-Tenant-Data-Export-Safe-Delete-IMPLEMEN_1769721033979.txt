STEP 12 (Backups + Tenant Data Export + Safe Delete) — IMPLEMENTATION PROMPT

GOAL
Add tenant-safe backups, one-click data export, and a safe delete flow so customers
can trust the platform with their data (compliance-ready).

NON-NEGOTIABLE RULES
1) Additive only. Do NOT refactor existing business logic.
2) No destructive operations without explicit confirmation + audit logs.
3) Exports must be tenant-scoped and RBAC enforced.
4) Proof-first with raw outputs/screenshots.
5) Must work on Replit (no external infra required).

WHAT TO BUILD

A) Tenant Data Export (Admin/Owner)
- Endpoint: POST /api/exports/tenant
- Scope: current tenant only
- Format: ZIP containing JSON files per domain:
  - tenant.json
  - users.json
  - memberships.json
  - modules.json
  - connectors.json
  - billing.json (invoices, payments)
  - audit_logs.json
- Async job (use STEP 10 jobs infra):
  - Create ExportJob record (status: pending|ready|failed)
  - Store file in local storage (tmp/exports) with expiry (24h)
- Endpoint to download:
  - GET /api/exports/tenant/:id/download

B) Backup Hooks (Non-destructive)
- Endpoint: POST /api/backups/snapshot (admin only)
- Creates a read-only snapshot metadata record:
  - timestamp
  - counts per table (no data copy required)
- Purpose: “Proof of backup taken” for audits
- Optional: daily cron snapshot via STEP 10 scheduler

C) Safe Delete (Workspace)
- Endpoint: POST /api/tenants/:id/delete (owner only)
- Two-step confirmation:
  1) Request delete → returns confirmation token
  2) Confirm delete with token
- Behavior:
  - Soft-delete tenant (deletedAt)
  - Disable auth/login for tenant
  - Revoke API keys
  - Keep data for retention window (e.g., 30 days)
- Provide restore endpoint within retention:
  - POST /api/tenants/:id/restore

D) UI (Minimal but Clear)
- /dashboard/data
  - “Export my data” button (shows job status, download link)
  - “Request delete workspace” with warnings + confirmation
  - “Restore workspace” (if within retention)
- Clear human-language warnings

E) Security & Compliance
- RBAC: owner/admin only
- Tenant isolation mandatory
- Audit log events:
  - DATA_EXPORT_REQUESTED
  - DATA_EXPORT_READY
  - TENANT_DELETE_REQUESTED
  - TENANT_DELETED
  - TENANT_RESTORED

F) Documentation
- Update DEPLOY.md:
  - How exports work
  - Retention policy
  - Restore window
- Create reports/step12-proof.md

PROOF REQUIRED (MANDATORY)
1) API proofs (raw):
   - POST /api/exports/tenant → returns export job id
   - GET download endpoint → HTTP 200 (ZIP)
2) Show ZIP contents listing files above
3) Safe delete flow:
   - Request delete → confirmation token
   - Confirm delete → tenant disabled
   - Restore → tenant re-enabled
4) RBAC proof:
   - Staff token blocked (403) on export/delete
5) JobRun/ExportJob records shown
6) ./scripts/verify.sh PASS + ./scripts/smoke.sh PASS
7) List changed files + git status
8) reports/step12-proof.md with outputs/screenshots

STOP CONDITION
Stop after STEP 12 proof is delivered.
Do NOT start STEP 13 (Monitoring/Alerts) until STEP 12 is accepted.
