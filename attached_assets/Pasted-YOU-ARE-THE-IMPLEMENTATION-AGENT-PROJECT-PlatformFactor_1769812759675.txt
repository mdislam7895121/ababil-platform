YOU ARE THE IMPLEMENTATION AGENT.

PROJECT: PlatformFactory
STEP: 30
TITLE: Real Store Publish Enablement (CI Runner + Credential Gating + Non-Simulated Proof)

NON-NEGOTIABLE GLOBAL RULES (PROOF-FIRST + NON-BREAKING)
1) Do NOT refactor working code. Additive changes only. Minimal diffs.
2) Do NOT claim "complete" without raw proof outputs.
3) Simulation is NOT allowed in STEP 30 for the core publish proof. If a capability cannot run here, you must use CI (GitHub Actions) to run it for real and attach logs + artifacts.
4) Every new endpoint must have RBAC (admin only) + tenant isolation + rate limits + audit logs.
5) Update verification scripts and create a proof report. Commit with clear message.

CURRENT STATE (ASSUME EXISTING)
- Mobile Builder supports targets: expo, flutter, flutterflow (Step 27/28).
- Mobile Publish Core exists (Step 28 Part 2): credentials CRUD + publish jobs + artifacts.
- Runner exists (Step 29): mobilePublishRunner with logs endpoint and run-now.
- Step 29 currently allows simulation with explicit reason. STEP 30 must add a REAL mode that produces real build/proof via CI.

STEP 30 GOAL
Enable real builds and real store submission attempts using CI runner:
- Expo: real EAS build (at least build, submit optional)
- Flutter: real Android build (AAB) using CI (Gradle)
- FlutterFlow: “Mode A” remains instructions-based, but must generate a CI-ready export path too (Mode B optional)

DELIVERABLES
A) Capability Matrix + Gating
1) Add a capability resolver for publish targets:
   - expo: requires EAS token + app.json/eas.json + bundle/package ids
   - flutter: requires android signing + package name; iOS optional
   - flutterflow: requires export.json and manual import OR Mode B pipeline (optional)
2) Add API endpoint:
   GET /api/mobile/publish/capabilities
   - returns what is possible NOW (local runner) vs requires CI
   - returns missing credentials checklist per target/provider
3) Update /dashboard/mobile/publish UI:
   - Show “Credential readiness” checklist per platform (iOS/Android)
   - Show “Run builds on” selector:
     a) Local runner (only for dev)
     b) GitHub Actions CI (required for real proofs)
   - Block “Start Publish” if required credentials missing or CI not configured

B) GitHub Actions CI Runner (REAL)
1) Create a GitHub Actions workflow that can run real builds:
   Path: .github/workflows/mobile-publish.yml
   Inputs:
     - jobId
     - target (expo|flutter)
     - tenantId
   Secrets needed (document clearly):
     - EXPO_TOKEN (for EAS)
     - ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD
     - (Optional iOS) APP_STORE_CONNECT_ISSUER_ID, KEY_ID, PRIVATE_KEY_BASE64
2) The workflow should:
   - checkout repo
   - set up node (and Java for Android)
   - for Expo: run eas build --platform android --non-interactive and capture the build URL
   - for Flutter: run flutter build appbundle with signing and produce .aab artifact
   - upload artifacts to GitHub Actions artifacts
   - print raw logs in workflow output
3) Add API endpoint to trigger CI:
   POST /api/mobile/publish/jobs/:id/trigger-ci
   - Admin only
   - Validates job is queued and target supported for CI
   - Creates a CI trigger record + stores workflow run URL once available (best-effort)
   - Audit log: MOBILE_PUBLISH_CI_TRIGGERED

C) CI Status + Artifact Ingestion
1) Add endpoints:
   GET /api/mobile/publish/jobs/:id/ci
   - returns CI status: not_configured | queued | running | success | failed
   - includes last run URL and last known logs snippet (if available)
2) Add a manual artifact attach endpoint:
   POST /api/mobile/publish/jobs/:id/artifacts/attach
   - Admin only
   - Allows attaching artifact metadata: type, url, size, expiresAt, simulated=false
   - Used if automatic ingestion isn’t possible
   - Audit log: MOBILE_PUBLISH_ARTIFACT_ATTACHED
3) Update UI Jobs tab to show CI run status + link + artifacts list.

D) Hard Rule: No Simulation for STEP 30 Proof
- For Step 30 proof pack, you must provide:
  1) A real EAS build URL (not simulated) OR if not possible, show CI run logs proving eas build ran.
  2) A real Flutter .aab artifact produced by CI, or CI logs showing gradle produced it.
- If CI cannot run due to missing secrets, you must stop and output:
  - exact secrets required
  - exact steps for owner to create them
  - do NOT mark step complete

E) Proof Pack Requirements (MUST PROVIDE RAW OUTPUTS)
Create: reports/step30-proof.md with:
1) curl outputs:
   - GET /api/mobile/publish/capabilities
   - POST /api/mobile/publish/jobs/:id/trigger-ci
   - GET /api/mobile/publish/jobs/:id/ci
2) Screenshots not required, but UI route must be verified with HTTP 200:
   - /dashboard/mobile/publish
3) GitHub Actions:
   - workflow file content summary
   - raw link or run id info (no secrets)
   - pasted logs excerpt showing real build command executed
4) Artifact proof:
   - Expo: EAS build URL recorded in job artifacts with simulated=false
   - Flutter: aab artifact recorded with simulated=false
5) Regression:
   - ./scripts/smoke.sh full output
   - ./scripts/verify.sh last 40 lines (warnings ok if pre-existing)
6) Git:
   - git diff summary
   - git status
   - commit hash

IMPLEMENTATION CONSTRAINTS
- Keep all new code in existing style.
- Do NOT change existing Step 28/29 behaviors unless necessary; add “real_ci” mode rather than breaking existing “simulation” path.
- Redact secrets from logs. Never print tokens/keys.

START NOW
1) Inspect current mobile publish routes + runner.
2) Implement capabilities endpoint + UI readiness gating first.
3) Add CI trigger endpoint and GitHub Actions workflow.
4) Provide Step 30 proof pack with REAL build evidence (non-simulated) or stop with missing secrets checklist.

STOP CONDITIONS
- If CI secrets are not present, stop after implementing everything and output the missing secrets checklist and where to set them (GitHub repo settings).
- Do NOT proceed to Step 31.