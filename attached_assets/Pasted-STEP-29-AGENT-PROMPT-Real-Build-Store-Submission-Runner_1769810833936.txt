STEP 29 AGENT PROMPT — Real Build + Store Submission Runner (Expo + Flutter + FlutterFlow)

NON-NEGOTIABLE RULES (proof-first):
1) No refactors. Additive changes only. Do not break Step 26-28.
2) Do not claim “complete” without raw outputs + artifacts.
3) Any external tool integration must be feature-flagged and safe by default.
4) Every new endpoint must be admin-only + tenant-isolated + rate-limited + audited.
5) Create reports/step29-proof.md with raw proofs and commands.

CURRENT STATE (already done):
- Mobile Builder generation works for targets: expo, flutter, flutterflow
- Publish Core exists:
  POST /api/mobile/publish/credentials
  GET  /api/mobile/publish/credentials/status
  DELETE /api/mobile/publish/credentials/:type
  POST /api/mobile/publish/start
  GET  /api/mobile/publish/jobs
  GET  /api/mobile/publish/jobs/:id
  POST /api/mobile/publish/jobs/:id/cancel
- Credentials encrypted with AES-256-GCM
- /dashboard/mobile/publish UI exists

STEP 29 GOAL:
Add actual build + submission execution layer (runner) so a publish job can:
- For EXPO: trigger EAS Build and optionally EAS Submit
- For FLUTTER: produce Android AAB/APK and optionally submit via Google Play (service account)
- For FLUTTERFLOW: support 2 modes:
  Mode A (recommended): “Export-only” + show instructions (FlutterFlow account required)
  Mode B (optional): If export->flutter project is generated, treat it like Flutter and build it

IMPORTANT REALITY:
This environment may not support real App Store submission without real credentials.
So Step 29 MUST support two stages:
- Stage 1: Build artifact generation (always possible if toolchain exists)
- Stage 2: Store submit (only when credentials are valid and environment supports it)

ARCHITECTURE REQUIREMENT:
Implement a background worker runner (in apps/api) that pulls queued MobilePublishJob rows and executes them safely.
No blocking HTTP requests. /start should enqueue. Worker executes asynchronously.

A) DATA MODEL CHANGES (Prisma)
Add fields to MobilePublishJob:
- stage: "build" | "submit"
- provider: "eas" | "flutter_local" | "flutter_ci" | "flutterflow"
- target: "expo" | "flutter" | "flutterflow"
- status: queued|running|completed|failed|cancelled (already exists)
- logsPath or logsJson (store last N lines in DB as well)
Add MobilePublishArtifact entries:
- type: "aab" | "apk" | "ipa" | "eas_build_url" | "submit_receipt" | "logs" | "zip"
- filePath or url
- expiresAt (24h)
Migration must be additive.

B) RUNNER IMPLEMENTATION
Create apps/api/src/jobs/mobilePublishRunner.ts with:
- poll interval (e.g. every 30s) behind env flag MOBILE_PUBLISH_RUNNER_ENABLED=true
- claim job with transaction (avoid double-run)
- append logs with safe redaction
- stop if cancel requested

C) EXPO EXECUTION (EAS)
Credential type expected: expo (token)
Build steps:
- download generated expo ZIP from existing job artifact OR regenerate from approved spec
- unzip to /tmp/job-<id>/
- run: npm install (or use bun) then npx eas build --platform android --profile preview --non-interactive
- capture EAS build URL in artifact
Submit steps (optional, separate stage):
- npx eas submit --platform android --profile production --non-interactive
- store submit result (if possible)

Guardrails:
- If expo token missing → fail with clear error
- Never log raw tokens
- All outputs redacted

D) FLUTTER EXECUTION
Credential type expected (Android): google_play (service account JSON)
Build steps:
- download generated flutter ZIP
- unzip
- install flutter toolchain or use a docker image (preferred)
- run: flutter pub get
- run: flutter build appbundle --release
- store AAB artifact path
Submit steps:
- use fastlane supply or Google Play Developer API (service account)
- store submission receipt/id

Guardrails:
- If toolchain missing, mark job failed with actionable message
- Never log JSON keys
- Rate limit submit start endpoint remains enforced

E) FLUTTERFLOW EXECUTION
Mode A (default):
- For flutterflow target, publish job should produce:
  - export.json (already)
  - a “PUBLISH_INSTRUCTIONS.md” artifact explaining manual publish steps in FlutterFlow UI
- Mark stage=build as completed with instructions artifact
- Submit stage is not supported unless Mode B enabled

Mode B (feature flag FLUTTERFLOW_AUTO_BUILD_ENABLED):
- if export can be transformed into flutter project (optional), then build like Flutter

F) API CHANGES (minimal)
Do NOT add many new endpoints.
Add ONLY:
- POST /api/mobile/publish/jobs/:id/run-now (admin only) to trigger runner immediately (optional)
- GET /api/mobile/publish/jobs/:id/logs (admin only) if logs not embedded

G) WEB UI CHANGES (minimal, additive)
Update /dashboard/mobile/publish:
- Show job stages (build/submit)
- Show artifacts list with download links (AAB/APK/URLs/instructions)
- Show last 200 lines logs (redacted)
- Show “Submit” button only when build artifact exists and required credentials exist

H) SECURITY
- requireRole('admin')
- tenant isolation
- rate limit run-now and logs
- audit log events:
  MOBILE_PUBLISH_JOB_ENQUEUED
  MOBILE_PUBLISH_JOB_STARTED
  MOBILE_PUBLISH_JOB_COMPLETED
  MOBILE_PUBLISH_JOB_FAILED
  MOBILE_PUBLISH_JOB_CANCELLED
  MOBILE_PUBLISH_SUBMIT_STARTED (if submit stage)

I) PROOF PACK (MUST)
Create reports/step29-proof.md with:
1) Health/Ready: curl outputs
2) RBAC: 401/403 outputs
3) Enqueue job: raw output (job id)
4) Runner logs: show status transitions queued→running→completed (or failed with reason)
5) Artifact proof:
   - Expo: store EAS build URL artifact OR local build artifact if available
   - Flutter: AAB artifact exists OR fail reason with actionable message
   - FlutterFlow: instructions artifact exists
6) Rate limit proof (429 + Retry-After)
7) Regression:
   ./scripts/smoke.sh full output
   ./scripts/verify.sh last ~40 lines
8) git status + changed files list

DEFINITION OF DONE:
- Jobs run asynchronously via runner
- Artifacts produced per target as described
- Logs visible and redacted
- UI shows job + artifacts
- Proof pack saved and smoke.sh passes
STOP after Step 29 proof pack. Do not start Step 30.