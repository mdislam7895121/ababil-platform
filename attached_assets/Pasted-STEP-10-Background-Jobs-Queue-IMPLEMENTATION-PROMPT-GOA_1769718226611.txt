STEP 10 (Background Jobs + Queue) — IMPLEMENTATION PROMPT

GOAL
Move slow/async work off the request path and make scheduled cleanup reliable:
- Expired preview sessions cleanup
- i18n cache expiry cleanup
- Optional: invoice pdf generation (if currently dynamic), email dispatch hooks
This must reduce timeouts and improve production stability.

NON-NEGOTIABLE RULES
1) Additive only. Do NOT refactor existing routes/business logic.
2) Must work on Replit. Use the simplest reliable approach first.
3) Proof-first. No “done” without logs + outputs.
4) Jobs must be idempotent (safe to run repeatedly).
5) All job runs must be audit-logged.

DESIGN CHOICE (RECOMMENDED)
Use node-cron (or equivalent) + a lightweight JobRun table for tracking.
Do NOT introduce heavy infra (Redis/BullMQ) unless strictly necessary.

WHAT TO BUILD

A) Job Runner Module
Create: apps/api/src/jobs/
- index.ts (register all jobs)
- scheduler.ts (cron setup)
- jobs/cleanupPreviewSessions.ts
- jobs/cleanupI18nCache.ts
Each job should:
- run inside a safe try/catch
- log start/end
- record JobRun row (name, status, startedAt, endedAt, details)
- be idempotent

B) Prisma Model
Add model: JobRun
Fields:
- id
- name (string)
- status ("success" | "failed")
- startedAt
- endedAt
- details (json/text)
- createdAt

C) Job Logic
1) cleanupPreviewSessions
- Find preview sessions where:
  - status active AND expiresAt < now
  - OR revoked=true
- Mark them as expired (or delete if existing design prefers)
- Ensure public validate endpoint rejects expired
- Record counts cleaned

2) cleanupI18nCache
- Remove cache entries older than 30 days
- Record counts cleaned

D) API Endpoint (Admin-only)
Add:
- GET /api/jobs/runs?limit=50 (admin/owner only)
Return recent JobRun entries.

E) Server Startup Wiring
Ensure API server loads scheduler on startup ONLY ONCE.
Guard against multiple schedulers in dev reload.
Document how to disable jobs via env var:
- JOBS_ENABLED=true/false

F) Scripts Integration
Update scripts/verify.sh (from STEP 9) to include:
- curl /api/jobs/runs (should return 200 for admin, 403 for staff)
Do not break existing verification.

PROOF REQUIRED (MANDATORY)
1) Paste logs showing scheduler started:
   - “Jobs scheduler enabled”
   - job run start/end
2) Demonstrate preview cleanup:
   - Create a preview session with expiresAt in the past (or simulate)
   - Run cleanup job (manual trigger or wait one cron tick)
   - Show validate endpoint now rejects it
3) Demonstrate i18n cache cleanup:
   - Create a cache entry older than threshold (or simulate)
   - Run cleanup
   - Show entry removed
4) API proof:
   - GET /api/jobs/runs returns rows
   - Staff token gets 403
5) Update reports/step10-proof.md with outputs + screenshots/logs.
6) git status + list of changed files

STOP CONDITION
Stop after STEP 10 proof is delivered.
Do NOT start STEP 11 (Rate limiting / abuse guard) until STEP 10 is accepted.
