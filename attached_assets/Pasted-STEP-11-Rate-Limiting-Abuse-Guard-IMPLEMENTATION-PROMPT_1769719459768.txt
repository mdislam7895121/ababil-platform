STEP 11 (Rate Limiting + Abuse Guard) — IMPLEMENTATION PROMPT

GOAL
Add production-grade rate limiting and abuse protection across critical endpoints
without breaking any existing flows.

NON-NEGOTIABLE RULES
1) Additive only. Do NOT refactor existing route logic.
2) Must preserve Golden Flows F1–F4 (from STEP 9).
3) Rate limits must be tenant-aware where applicable and safe behind proxies.
4) Provide clear, human-readable 429 responses and Retry-After headers.
5) Proof-first with raw curl outputs, not summaries.

RECOMMENDED TECH
Use express-rate-limit (or equivalent) + a small custom key generator:
- For public endpoints: key by IP
- For authenticated endpoints: key by tenantId + userId
- For token endpoints: key by token hash (where relevant)

WHAT TO BUILD

A) Core Rate Limit Middleware
Create: apps/api/src/middleware/rateLimit.ts
- Standard limiter factory:
  - windowMs
  - max
  - key strategy (ip | tenantUser | token)
  - routeName for logging/audit
- Ensure trust proxy is set correctly (Express) to read client IP in Replit.

B) Apply Limits (Minimum Set)

1) Auth endpoints (HIGH RISK)
- POST /api/auth/login: 10 per 5 min per IP
- POST /api/auth/register: 5 per 10 min per IP

2) Builder endpoints (COST + ABUSE)
- POST /api/builder/draft: 20 per hour per tenant
- POST /api/builder/run: 10 per hour per tenant
- POST /api/builder/approve: 30 per hour per tenant

3) Preview endpoints (BRUTE FORCE RISK)
- GET /api/preview/validate: 120 per 5 min per IP
- GET /api/preview/demo-data: 120 per 5 min per IP
- POST /api/preview/create: 30 per hour per tenant

4) Billing/payment endpoints (FRAUD/ABUSE)
- POST /api/billing/checkout: 10 per hour per tenant
- POST /api/payments/manual: 20 per day per tenant
- POST /api/payments/manual/:id/approve: 60 per hour (admin only)

5) AI/i18n endpoints (COST CONTROL)
- Any AI translation generate endpoint: 30 per hour per tenant (in addition to quotas)
- AI assistant endpoints: 60 per hour per tenant (in addition to quotas)

C) Response Format
On rate limit exceeded:
- HTTP 429
- JSON:
  {
    "error": "Too many requests",
    "code": "RATE_LIMITED",
    "route": "<routeName>",
    "retryAfterSeconds": <number>
  }
- Set Retry-After header.

D) Observability
- Log rate limit blocks (routeName, keyType, tenantId if available)
- OPTIONAL: write AuditLog event type: RATE_LIMIT_BLOCKED (do not log IP raw if you want privacy; hash ok)

E) Ensure Non-breaking Behavior
- Default to permissive limits for normal usage
- Confirm login + onboarding + preview + billing flows still pass STEP 9 verify scripts

PROOF REQUIRED (MANDATORY)
1) Show Golden Flows still pass:
   - ./scripts/verify.sh (PASS)
   - ./scripts/smoke.sh (PASS)

2) Show rate limiting works with raw curl outputs:
   A) Login endpoint:
      - Send >10 requests quickly and show 429 + Retry-After
   B) Preview validate:
      - Burst requests and show 429
   C) Builder draft:
      - Burst beyond limit and show 429

3) Show response body matches required JSON with routeName and retryAfterSeconds.

4) Update reports/step11-proof.md with:
   - limits table
   - curl outputs
   - confirmation that verify/smoke passed
   - list of files changed

STOP CONDITION
Stop after STEP 11 proof is delivered.
Do NOT start STEP 12 (Backups/Data export) until STEP 11 is accepted.
