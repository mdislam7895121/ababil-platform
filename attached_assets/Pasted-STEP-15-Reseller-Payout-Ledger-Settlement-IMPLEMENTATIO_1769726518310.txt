STEP 15 (Reseller Payout Ledger + Settlement) — IMPLEMENTATION PROMPT

GOAL
Implement a payout ledger so reseller commissions can be tracked as owed → paid,
with monthly statements and admin-controlled settlement.
Must be auditable, tenant-safe, and non-breaking.

NON-NEGOTIABLE RULES
1) Additive only. No refactors to existing billing, invoices, reseller, or revenue split logic.
2) Money logic must be deterministic and auditable.
3) RBAC strict:
   - Platform admin/owner can manage payouts
   - Reseller can view only their own ledger + statements
4) Proof-first with raw outputs.
5) Must not break Golden Flows F1–F4.

WHAT TO BUILD

A) Prisma Models (Additive)
1) ResellerPayout
- id
- resellerId
- periodStart (date)
- periodEnd (date)
- currency (USD/BDT)
- grossRevenue (decimal)
- commissionEarned (decimal)
- adjustments (decimal, default 0)
- netPayable (decimal)
- status (owed | approved | paid | void)
- approvedAt, paidAt
- payoutMethod (bank|bkash|stripe|manual) + payoutDetails (json)
- createdAt, updatedAt

2) ResellerLedgerEntry
- id
- resellerId
- invoiceId (nullable)
- currency
- type (commission_accrual | adjustment | payout)
- amount (decimal, positive for accrual, negative for payout)
- note (string)
- occurredAt
- createdAt

B) Ledger Generation Rules
1) On every PAID invoice that is associated with a reseller:
- Create a ResellerLedgerEntry:
  type=commission_accrual, amount=commissionAmount, invoiceId set
- Must be idempotent:
  - If entry already exists for invoiceId+resellerId, skip

2) Adjustments:
- Admin can add adjustment entries (+/-) with note and audit log

3) When payout marked PAID:
- Create ledger entry type=payout amount = -netPayable

C) Monthly Statement (Payout Draft)
Endpoints (admin/owner):
1) POST /api/resellers/:id/payouts/generate
Body: { periodStart, periodEnd, currency }
Returns a draft payout with computed totals based on ledger entries/invoices in period.
2) GET /api/resellers/:id/payouts?limit=50
3) GET /api/resellers/:id/payouts/:payoutId
4) POST /api/resellers/:id/payouts/:payoutId/approve
5) POST /api/resellers/:id/payouts/:payoutId/mark-paid
Body: { payoutMethod, payoutDetails }
6) POST /api/resellers/:id/ledger/adjust
Body: { currency, amount, note }

Reseller access (reseller role):
- GET /api/my/reseller/payouts
- GET /api/my/reseller/ledger

D) Admin UI
Pages:
1) /dashboard/resellers/payouts
- Select reseller + period
- Generate payout draft
- Show breakdown (invoices count, gross, commission, adjustments, net)
- Approve + Mark Paid actions
- Export CSV (optional but preferred)

2) /dashboard/reseller/payouts (reseller view)
- View own payouts + status
- View ledger

E) Audit Logging
Events:
- RESELLER_PAYOUT_GENERATED
- RESELLER_PAYOUT_APPROVED
- RESELLER_PAYOUT_MARKED_PAID
- RESELLER_LEDGER_ADJUSTED

F) Verification Hooks
Update scripts/verify.sh to include a basic check:
- GET reseller payouts endpoint (admin) returns 200
- reseller-only endpoints return 200 for reseller, 403 for non-reseller

PROOF REQUIRED (MANDATORY)
1) Create/identify a reseller-linked paid invoice (or simulate payment approval flow).
2) Show ledger accrual created (raw API or DB query output).
3) Generate payout for a month:
   - POST generate → returns payout with correct netPayable
4) Approve payout → status becomes approved
5) Mark paid → status becomes paid and payout ledger entry created (negative amount)
6) RBAC proofs:
   - Staff cannot approve/mark paid (403)
   - Reseller sees only own data
7) UI screenshots:
   - Admin payouts page with one payout record
   - Reseller payouts page with same record
8) Regression proof:
   - ./scripts/smoke.sh PASS
   - ./scripts/verify.sh PASS (warnings ok if pre-existing)
9) Create reports/step15-proof.md with raw outputs + screenshots references
10) List changed files + git status

STOP CONDITION
Stop after STEP 15 proof is delivered.
Do NOT start STEP 16.