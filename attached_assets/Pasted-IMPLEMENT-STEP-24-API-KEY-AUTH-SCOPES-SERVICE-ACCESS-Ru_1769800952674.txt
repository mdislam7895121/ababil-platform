IMPLEMENT STEP 24: API KEY AUTH + SCOPES + SERVICE ACCESS
Rules:
- Non-breaking only
- Proof-first: no “done” claim without raw curl + logs + smoke/verify
- Do not refactor unrelated files
- Keep existing Bearer auth working exactly as-is
- Add additive API-key auth that works in parallel

Goal:
Enable calling protected APIs using:
- Authorization: ApiKey <raw_key>
OR
- x-api-key: <raw_key>
while still supporting Bearer tokens.

STEP 24 REQUIREMENTS
A) API Key Storage & Security
1) Store only hashed API keys in DB (never store raw key).
2) Return raw key ONLY once at creation and rotation.
3) Keep keyPrefix (for display) and lastUsedAt, lastUsedIp.
4) Add scopes array (strings). Default: ["read"].
5) Add status: active/revoked + revokedAt.

B) Auth Middleware
1) Create middleware: requireAuth() that accepts either Bearer JWT or API key.
2) If API key is used:
   - validate hash
   - check status active
   - check tenant binding (x-tenant-id required)
   - enforce scope per route
   - update lastUsedAt + lastUsedIp
3) If Bearer JWT is used: existing behavior unchanged.

C) Scope Enforcement
Define scopes (minimum):
- read
- builder:write
- billing:write
- marketplace:install
- support:write
- admin:write

Map at least 10 routes to scopes (example):
- GET /api/health => public (no auth)
- GET /api/audit-logs => read
- POST /api/builder/draft => builder:write
- POST /api/billing/checkout => billing:write
- POST /api/marketplace/install => marketplace:install
- POST /api/support/tickets => support:write
- POST /api/security-center/settings => admin:write

D) Admin UX
Update dashboard API Keys page:
- Show scopes badges
- Create key with scopes selector
- Rotate key keeps scopes
- Revoke key button
- Show lastUsedAt + lastUsedIp

E) Rate Limiting
Add dedicated limiter for API-key auth usage bursts (tenant+keyPrefix based).

F) Audit Logging
Log:
- API_KEY_USED (entity: api_key)
- API_KEY_REVOKED
- API_KEY_SCOPES_UPDATED

PROOF PACK (MANDATORY)
1) Create key with scopes:
curl -s -X POST http://localhost:5000/api/api-keys \
-H "Authorization: Bearer $OWNER_TOKEN" -H "x-tenant-id: $TENANT_ID" \
-H "Content-Type: application/json" \
-d '{"name":"step24-key","scopes":["read","builder:write"]}'

Paste full output (must show raw key once + prefix + scopes).

2) Use API key successfully on READ endpoint:
curl -i http://localhost:5000/api/audit-logs \
-H "x-tenant-id: $TENANT_ID" \
-H "Authorization: ApiKey <RAW_KEY>"

Must return 200.

3) Scope denial:
Try POST /api/billing/checkout using same key (missing billing:write) => must 403.
Paste output.

4) Use Bearer token still works (regression):
curl -i http://localhost:5000/api/audit-logs \
-H "Authorization: Bearer $OWNER_TOKEN" -H "x-tenant-id: $TENANT_ID"
Must be 200.

5) Rotate key:
curl -s -X POST http://localhost:5000/api/api-keys/<ID>/rotate \
-H "Authorization: Bearer $OWNER_TOKEN" -H "x-tenant-id: $TENANT_ID"
Then:
- old key => 401
- new key => 200
Paste outputs.

6) Revoke key:
curl -s -X POST http://localhost:5000/api/api-keys/<ID>/revoke \
-H "Authorization: Bearer $OWNER_TOKEN" -H "x-tenant-id: $TENANT_ID"
Then same key => 401. Paste outputs.

7) lastUsedAt/ip proof:
Show GET /api/api-keys lists updated lastUsedAt after using key.

8) Regression:
./scripts/smoke.sh full output
./scripts/verify.sh last ~50 lines

9) Artifacts:
Create reports/step24-proof.md with:
- endpoints mapped to scopes table
- raw curl outputs (trim huge responses safely)
- changed files list + git status

STOP after proof pack.